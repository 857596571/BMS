<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.modules.system.mapper.SysMenuMapper">

    <!-- 通用sql -->
    <sql id="selectColumns">
        SELECT DISTINCT
            a.id,
            a.parent_id,
            a.left_num,
            a.right_num,
            a.name,
            a.href,
            a.icon,
            a.sort,
            a.level,
            a.state,
            a.permission,
            a.remarks,
            a.create_date,
            a.update_date
        FROM sys_menu a
    </sql>

    <!-- 根据用户查询菜单 -->
    <select id="findListByUserId" resultType="com.modules.system.entity.SysMenu">
        <include refid="selectColumns"/>
        <if test="@cn.hutool.core.util.StrUtil@isNotBlank(href)">
            join (select m.* from sys_menu m where m.href=#{href}) t on a.left_num &gt; t.left_num and a.right_num &lt; t.right_num
        </if>
        JOIN sys_role_menu rm ON rm.menu_id = a.id
        JOIN sys_role r ON r.id = rm.role_id AND r.state = 'ON' AND r.del_flag = '0'
        JOIN sys_user_role ur ON ur.role_id = r.id
        JOIN sys_user u ON u.id = ur.user_id AND u.id = #{userId}
        WHERE a.del_flag = '0' and a.state = 'ON'
        ORDER BY a.sort
    </select>

    <!-- 根据角色查询菜单 -->
    <select id="findListByRoleId" resultType="com.modules.system.entity.SysMenu">
        <include refid="selectColumns"/>
        LEFT JOIN sys_role_menu rm ON rm.menu_id = a.id
        WHERE a.del_flag = '0' and a.state = 'ON'
        AND rm.role_id = #{roleId}
        ORDER BY a.sort
    </select>

    <!-- 查询菜单列表 -->
    <select id="findList" resultType="com.modules.system.entity.SysMenu">
        <include refid="selectColumns"/>
        <if test="@cn.hutool.core.util.StrUtil@isNotBlank(href)">
            join (select m.* from sys_menu m where m.href=#{href}) t on a.left_num &gt; t.left_num and a.right_num &lt; t.right_num
        </if>
        WHERE a.del_flag = '0'
        <if test="@cn.hutool.core.util.StrUtil@isNotBlank(state)">
            and a.state = #{state}
        </if>
        ORDER BY a.sort
    </select>

    <!-- 查询左右值 -->
    <select id="getLRNum" resultType="int">
        select a.right_num from sys_menu a
        where a.id = #{parentId}
        ORDER BY a.right_num desc
        limit 1
    </select>

    <!-- 更新左值 -->
    <update id="updateLNum">
        update sys_menu set
        <if test='delFlag != "1"'>
            left_num = left_num + 2 where left_num &gt;= #{rightNum}
        </if>
        <if test='delFlag == "1"'>
            left_num = left_num - #{treeNodeNum} where left_num &gt;= #{rightNum}
        </if>
    </update>

    <!-- 更新右值 -->
    <update id="updateRNum">
        update sys_menu set
        <if test='delFlag != "1"'>
            right_num = right_num + 2 where right_num &gt;= #{rightNum}
        </if>
        <if test='delFlag == "1"'>
            right_num = right_num - #{treeNodeNum} where right_num &gt;= #{rightNum}
        </if>
    </update>

    <!-- 保存菜单 -->
    <insert id="insert">
        INSERT INTO sys_menu (
            id,
            parent_id,
            left_num,
            right_num,
            name,
            href,
            icon,
            sort,
            state,
            level,
            permission,
            create_date,
            update_date,
            remarks
        ) VALUES (
            #{id},
            #{parentId},
            #{leftNum},
            #{rightNum},
            #{name},
            #{href},
            #{icon},
            #{sort},
            #{state},
            #{level},
            #{permission},
            #{createDate},
            #{updateDate},
            #{remarks}
        )
    </insert>

    <!-- 更新菜单 -->
    <update id="update">
        UPDATE sys_menu
        <set>
            <if test="parentId != null and parentId != ''">parent_id = #{parentId}, </if>
            <if test="name != null and name != ''">name = #{name}, </if>
            <if test="href != null and href != ''">href = #{href}, </if>
            <if test="icon != null and icon != ''">icon = #{icon}, </if>
            <if test="sort != null and sort != ''">sort = #{sort}, </if>
            <if test="level != null and level != ''">level = #{level}, </if>
            <if test="state != null and state != ''">state = #{state}, </if>
            <if test="permission != null and permission != ''">permission = #{permission}, </if>
            <if test="updateDate != null">update_date = #{updateDate}, </if>
            remarks = #{remarks}
        </set>
        WHERE id = #{id}
    </update>

    <!-- 更新菜单排序 -->
    <update id="updateSort" parameterType="com.modules.system.entity.SysMenu">
		update sys_menu set sort = #{sort} where id = #{id}
	</update>

    <!-- 更新菜单状态 -->
    <update id="updateStates">
		update sys_menu set state = #{state} where
		<if test='state == "OFF"'>
            left_num &gt;= #{leftNum} and right_num &lt;= #{rightNum}
        </if>
        <if test='state == "ON"'>
            left_num &lt;= #{leftNum} and right_num &gt;= #{rightNum}
        </if>
	</update>

    <!-- 删除菜单 -->
    <delete id="delete">
		delete from sys_menu WHERE left_num &gt;= #{leftNum} and right_num &lt;= #{rightNum}
	</delete>

</mapper>